datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  email                     String?         @unique
  username                  String?         @unique
  isAdmin                   Boolean         @default(false)

  paymentProcessorUserId    String?         @unique
  lemonSqueezyCustomerPortalUrl String?     // You can delete this if you're not using Lemon Squeezy as your payments processor.
  subscriptionStatus        String?         // 'active', 'cancel_at_period_end', 'past_due', 'deleted'
  subscriptionPlan          String?         // 'hobby', 'pro'
  datePaid                  DateTime?
  credits                   Int             @default(3)
  contactFormMessages       ContactFormMessage[]
  submissions               Submission[]
}



model DailyStats {
  id                               Int             @id @default(autoincrement())
  date                             DateTime        @default(now()) @unique

  totalViews                       Int             @default(0)
  prevDayViewsChangePercent        String          @default("0")
  userCount                        Int             @default(0)
  paidUserCount                    Int             @default(0)
  userDelta                        Int             @default(0)
  paidUserDelta                    Int             @default(0)
  totalRevenue                     Float           @default(0)
  totalProfit                      Float           @default(0)

  sources                          PageViewSource[]
}

model PageViewSource {
  @@id([date, name])
  name                     String
  date                     DateTime        @default(now())

  dailyStats               DailyStats?     @relation(fields: [dailyStatsId], references: [id])
  dailyStatsId             Int?

  visitors                 Int
}

model Logs {
  id                       Int             @id @default(autoincrement())
  createdAt                DateTime        @default(now())

  message                  String
  level                    String
}

model ContactFormMessage {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  content                   String
  isRead                    Boolean         @default(false)
  repliedAt                 DateTime?
}

model Problem {
  id                        String          @id @default(uuid())
  title                     String
  slug                      String          @unique
  description               String
  difficulty                String          @default("Easy") // Easy, Medium, Hard
  timeLimit                 Int             @default(1) // Seconds
  memoryLimit               Int             @default(128) // MB
  starterCode               String?
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt

  testCases                 TestCase[]
  submissions               Submission[]
}

model TestCase {
  id                        String          @id @default(uuid())
  problem                   Problem         @relation(fields: [problemId], references: [id])
  problemId                 String

  input                     String
  expectedOutput            String
  isSample                  Boolean         @default(false)
  createdAt                 DateTime        @default(now())
  
  submissionResults         SubmissionTestCaseResult[]
}

model Submission {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  problem                   Problem         @relation(fields: [problemId], references: [id])
  problemId                 String

  code                      String
  language                  String
  status                    String          @default("PENDING") // PENDING, PROCESSING, ACCEPTED, WRONG_ANSWER, TIME_LIMIT_EXCEEDED, COMPILATION_ERROR, RUNTIME_ERROR

  runtime                   Runtime?        @relation(fields: [runtimeId], references: [id])
  runtimeId                 String?

  testCaseResults           SubmissionTestCaseResult[]
}

model SubmissionTestCaseResult {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  submission                Submission      @relation(fields: [submissionId], references: [id])
  submissionId              String

  testCase                  TestCase?       @relation(fields: [testCaseId], references: [id], onDelete: SetNull)
  testCaseId                String?

  status                    String // ACCEPTED, WRONG_ANSWER, etc.
  stdout                    String?
  executionTime             Int? // ms
  memoryUsage               Int? // MB
  
  // Snapshot of the test case at the time of submission
  input                     String          @default("")
  expectedOutput            String          @default("")
}

model Runtime {
  id                        String          @id @default(uuid())
  language                  String          @unique // e.g., "javascript", "python"
  defaultCode               String          @default("")
  
  submissions               Submission[]
}
